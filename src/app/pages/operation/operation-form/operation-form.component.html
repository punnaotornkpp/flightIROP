<div class="card">
  <div class="text-surface-900 dark:text-surface-0 block">
    <h2 class="text-2xl font-bold mb-6">Create Operation</h2>
    <form [formGroup]="form" (ngSubmit)="onAdd()" class="flex flex-col gap-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p-dropdown
          [options]="seasonOptions"
          formControlName="season"
          optionLabel="label"
          optionValue="code"
          placeholder="Select IATA Season"
          class="w-full"
        ></p-dropdown>

        <p-dropdown
          [options]="sourceTypeOptions"
          formControlName="sourceType"
          placeholder="Source Type"
          class="w-full"
        ></p-dropdown>
      </div>

      <textarea
        rows="4"
        pInputText
        formControlName="message"
        placeholder="Message*"
        class="w-full"
      ></textarea>

      <p-multiselect
        [options]="noteOptions"
        formControlName="noteOptions"
        optionLabel="description"
        optionValue="code"
        placeholder="Select Notes"
        class="w-full"
        [maxSelectedLabels]="5"
        display="chip"
      ></p-multiselect>
      <div *ngIf="addedSections.length > 0" class="mt-6 space-y-6">
        <div
          *ngFor="let section of addedSections; let i = index"
          class="border rounded-md p-4 bg-white shadow-sm"
        >
          <h3 class="text-lg font-semibold text-gray-700 mb-2">
            {{ section.title }}
            <span class="text-sm font-normal text-gray-400"
              >({{ section.actionType }})</span
            >
            <button
              pButton
              icon="pi pi-pencil"
              class="p-button-text p-button-sm"
              (click)="editSection(section, i)"
            ></button>
            <button
              pButton
              icon="pi pi-trash"
              class="p-button-text p-button-danger p-button-sm"
            ></button>
          </h3>

          <ng-container *ngFor="let flight of section.schedule">
            <div class="mb-4">
              <div class="text-sm text-gray-600 font-medium">
                {{ flight.flightNumber }} — {{ flight.origin }} →
                {{ flight.destination }}
              </div>
              <div class="text-sm text-gray-400">
                {{ flight.effectiveDate | date : "yyyy-MM-dd" }} to
                {{ flight.expirationDate | date : "yyyy-MM-dd" }}
              </div>

              <table class="w-full text-sm mt-2 border rounded overflow-hidden">
                <thead class="bg-gray-100 text-left">
                  <tr>
                    <th class="p-2">Day</th>
                    <th class="p-2">ETD</th>
                    <th class="p-2">ETA</th>

                    <!-- Conditional headers -->
                    <th class="p-2" *ngIf="section.actionType === 'REVISED'">
                      Revised ETD
                    </th>
                    <th class="p-2" *ngIf="section.actionType === 'REVISED'">
                      Revised ETA
                    </th>
                    <th class="p-2" *ngIf="section.actionType === 'REVISED'">
                      Aircraft
                    </th>
                    <th
                      class="p-2"
                      *ngIf="
                        section.actionType === 'INFORM' ||
                        section.actionType === 'RESUME'
                      "
                    >
                      Message
                    </th>
                    <th class="p-2" *ngIf="section.actionType === 'CANCELLED'">
                      Status
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let d of flight.schedule">
                    <td class="p-2">{{ getDayLabel(+d.frequency) }}</td>
                    <td class="p-2">{{ d.estimatedDeparture }}</td>
                    <td class="p-2">{{ d.estimatedArrival }}</td>

                    <!-- Conditional cells -->
                    <td class="p-2" *ngIf="section.actionType === 'REVISED'">
                      {{ d.revisedDeparture || "-" }}
                    </td>
                    <td class="p-2" *ngIf="section.actionType === 'REVISED'">
                      {{ d.revisedArrival || "-" }}
                    </td>
                    <td class="p-2" *ngIf="section.actionType === 'REVISED'">
                      {{ d.aircraft || "-" }}
                    </td>
                    <td
                      class="p-2"
                      *ngIf="
                        section.actionType === 'INFORM' ||
                        section.actionType === 'RESUME'
                      "
                    >
                      {{ d.message || "-" }}
                    </td>
                    <td
                      class="p-2 text-center"
                      *ngIf="section.actionType === 'CANCELLED'"
                    >
                      <span
                        [ngClass]="{
                          'text-red-600': !d.status,
                          'text-green-600': d.status
                        }"
                      >
                        {{ d.status ? "Active" : "Cancelled" }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="flex justify-between mt-6">
        <button
          pButton
          type="button"
          label="Back"
          class="p-button-outlined p-button-danger w-32"
          (click)="goBack()"
        ></button>

        <div class="flex gap-2">
          <button
            pButton
            type="button"
            icon="pi pi-plus"
            label="Add Flight"
            class="p-button-success"
            (click)="openAddFlightDialog()"
          ></button>
          <button
            pButton
            type="submit"
            label="Create"
            class="p-button-primary"
            [loading]="isLoading"
            [disabled]="isLoading"
          ></button>
        </div>
      </div>
    </form>
  </div>
  <app-flight-schedule-editor
    [(visible)]="flightDialogVisible"
    [mode]="flightEditMode"
    [sectionToEdit]="sectionToEdit"
    (close)="onFlightDialogClose()"
    (save)="onFlightDialogSave($event)"
  ></app-flight-schedule-editor>
</div>
